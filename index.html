<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ImgPal Cloud (v4.0 Ultimate)</title>
    
    <style>
        :root { --accent: #007acc; --bg: #111; --panel: #1e1e1e; --width-panel: 320px; }
        
        body { display: flex; flex-direction: row; height: 100vh; margin: 0; font-family: system-ui, -apple-system, sans-serif; background-color: var(--bg); color: white; overflow: hidden; touch-action: none; }
        
        .canvas-container { flex-grow: 1; position: relative; overflow: hidden; background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px; display: flex; align-items: center; justify-content: center; z-index: 1; }
        canvas { box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 100%; max-height: 100%; }
        
        .ui-panel { 
            width: var(--width-panel); 
            height: 100vh; 
            background-color: var(--panel); 
            border-right: 1px solid #333;
            display: flex; 
            flex-direction: column; 
            z-index: 10; 
            flex-shrink: 0;
            transition: margin-left 0.3s ease-in-out;
            position: relative;
        }

        .ui-panel.closed { margin-left: calc(var(--width-panel) * -1); }

        .app-header { display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #000; border-bottom: 1px solid #333; font-size: 14px; font-weight: 800; letter-spacing: 1px; color: var(--accent); }
        .btn-icon { background: none; border: none; color: #888; cursor: pointer; font-size: 16px; padding: 4px; transition: 0.2s; }
        .btn-icon:hover { color: white; }

        #btnRestorePanel {
            position: absolute; top: 15px; left: 15px; z-index: 20;
            background: var(--panel); border: 1px solid #444; color: white;
            padding: 10px 14px; border-radius: 6px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: none; font-weight: 600; font-size: 18px;
        }
        body.panel-hidden #btnRestorePanel { display: block; }
        
        .tabs { display: flex; flex-wrap: wrap; background: #252526; border-bottom: 1px solid #333; }
        .tab-btn { flex: 1 1 auto; padding: 12px 10px; background: none; border: none; color: #888; font-size: 11px; font-weight: 700; cursor: pointer; transition: 0.2s; text-transform: uppercase; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: white; background: var(--panel); border-bottom: 2px solid var(--accent); border-top: none; }
        
        .panel-content { flex-grow: 1; overflow-y: auto; padding: 20px; display: none; }
        .panel-content.active { display: block; animation: fadeIn 0.2s; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .slider-grid { display: flex; flex-direction: column; gap: 15px; }
        .control-group { margin-bottom: 12px; }
        
        label { display: flex; justify-content: space-between; font-size: 11px; color: #bbb; margin-bottom: 6px; font-weight: 600; letter-spacing: 0.5px; }
        input[type="range"] { width: 100%; accent-color: var(--accent); height: 4px; background: #444; border-radius: 2px; outline: none; }
        input[type="file"] { font-size: 11px; width: 100%; background: #333; padding: 10px; border-radius: 6px; color: #fff; box-sizing: border-box; }
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        button.tool-btn { padding: 10px; background: #333; border: 1px solid transparent; color: white; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button.tool-btn.active { background: var(--accent); }
        button.save-btn { width: 100%; background: #28a745; color: white; border: none; padding: 12px; border-radius: 6px; font-weight: 700; margin-top: 10px; cursor: pointer; }
        
        .status-bar { font-size: 11px; color: orange; margin-top: 8px; font-weight: 600; text-align: center; min-height: 16px; }
        svg { position: absolute; width: 0; height: 0; }

        .panel-content::-webkit-scrollbar { width: 6px; }
        .panel-content::-webkit-scrollbar-track { background: #1e1e1e; }
        .panel-content::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    </style>
</head>
<body>
    <svg><defs><filter id="svgSharpness"><feConvolveMatrix id="sharpMatrix" order="3" kernelMatrix="0 -1 0 -1 5 -1 0 -1 0"/></filter></defs></svg>

    <button id="btnRestorePanel" onclick="togglePanel()">☰</button>

    <div class="ui-panel" id="mainPanel">
        <div class="app-header">
            <span>IMGPAL CLOUD</span>
            <button class="btn-icon" onclick="togglePanel()" title="Minimize Panel">✕</button>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="ui.tab('files')">Assets</button>
            <button class="tab-btn" onclick="ui.tab('tools')">Tools</button>
            <button class="tab-btn" onclick="ui.tab('light')">Light</button>
            <button class="tab-btn" onclick="ui.tab('color')">Color</button>
            <button class="tab-btn" onclick="ui.tab('fx')">FX</button>
        </div>

        <div id="tab-files" class="panel-content active">
            <div class="control-group">
                <label>1. Add Person (Foreground)</label>
                <input type="file" id="fgInput" accept="image/*" disabled>
                <div id="statusText" class="status-bar">⏳ Connecting to Cloud...</div>
            </div>
            <div class="control-group">
                <label>2. Add Background</label>
                <input type="file" id="bgInput" accept="image/*">
            </div>
            <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #333;">
                <button class="save-btn" id="btnSave">Download Image</button>
            </div>
        </div>

        <div id="tab-tools" class="panel-content">
            <div class="btn-grid">
                <button class="tool-btn active" id="btnTransform" onclick="app.setMode('transform')">Move</button>
                <button class="tool-btn" id="btnErase" onclick="app.setMode('erase')">Erase</button>
                <button class="tool-btn" id="btnRestore" onclick="app.setMode('restore')">Restore</button>
            </div>
            <div id="brushControls" style="display:none; background: #252526; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div class="control-group"><label>Size <span id="valSize">40</span></label><input type="range" id="brushSize" min="5" max="150" value="40"></div>
                <div class="control-group" style="margin:0"><label>Softness <span id="valFeather">20</span></label><input type="range" id="brushFeather" min="0" max="50" value="20"></div>
            </div>
            <div class="control-group"><label>Rotation <span id="valRot">0°</span></label><input type="range" id="rotateSlider" min="0" max="360" value="0"></div>
            <div class="control-group" style="display:flex; align-items:center; gap:12px; background: #252526; padding: 12px; border-radius: 8px;">
                <input type="checkbox" id="checkGhost" style="width: 20px; height: 20px; margin:0;"> 
                <label for="checkGhost" style="margin:0; color:white; flex:1; cursor:pointer;">Ghost Mode</label>
            </div>
        </div>

        <div id="tab-light" class="panel-content">
            <div class="slider-grid">
                <div class="control-group"><label>Exposure</label><input type="range" id="filterExposure" min="-100" max="100" value="0"></div>
                <div class="control-group"><label>Brightness</label><input type="range" id="filterBrightness" min="-100" max="100" value="0"></div>
                <div class="control-group"><label>Contrast</label><input type="range" id="filterContrast" min="-100" max="100" value="0"></div>
                <div class="control-group"><label>Highlights</label><input type="range" id="filterHighlights" min="0" max="100" value="0"></div>
                <div class="control-group"><label>Shadows</label><input type="range" id="filterShadows" min="0" max="100" value="0"></div>
                <div class="control-group"><label>Opacity</label><input type="range" id="filterOpacity" min="0" max="100" value="100"></div>
            </div>
        </div>

        <div id="tab-color" class="panel-content">
             <div class="slider-grid">
                <div class="control-group"><label>Saturation</label><input type="range" id="filterSaturation" min="-100" max="100" value="0"></div>
                <div class="control-group"><label>Vibrance</label><input type="range" id="filterVibrance" min="-100" max="100" value="0"></div>
                <div class="control-group"><label>Warmth / Temp</label><input type="range" id="filterTemp" min="-100" max="100" value="0"></div>
                <div class="control-group"><label>Tint (Green/Magenta)</label><input type="range" id="filterTint" min="-100" max="100" value="0"></div>
                <div class="control-group"><label>Hue</label><input type="range" id="filterHue" min="-180" max="180" value="0"></div>
                <div class="control-group"><label>Sepia</label><input type="range" id="filterSepia" min="0" max="100" value="0"></div>
             </div>
        </div>

        <div id="tab-fx" class="panel-content">
            <div style="border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:15px;">
                <label style="color:var(--accent); font-weight:800;">EDGE FUZZ</label>
                <div class="control-group"><label>Fuzz Radius</label><input type="range" id="filterFuzzRadius" min="0" max="100" value="0"></div>
                <div class="control-group"><label>Intensity (Alpha Choke)</label><input type="range" id="filterFuzzInt" min="0" max="20" value="0"></div>
            </div>
            <div class="control-group"><label>Smooth (Surface Blur)</label><input type="range" id="filterSmooth" min="0" max="20" value="0"></div>
            <div class="control-group"><label>Sharpness</label><input type="range" id="filterSharpness" min="0" max="100" value="0"></div>
            <div class="control-group"><label>Grain / Noise</label><input type="range" id="filterNoise" min="0" max="100" value="0"></div>
            <button class="tool-btn" onclick="app.resetFilters()" style="background: #444; margin-top:15px; width:100%">Reset All Filters</button>
        </div>
    </div>

    <div class="canvas-container" id="canvasContainer"><canvas id="mainCanvas"></canvas></div>

    <script type="module">
        import { removeBackground } from 'https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.5.5/+esm';

        window.togglePanel = () => {
            document.getElementById('mainPanel').classList.toggle('closed');
            document.body.classList.toggle('panel-hidden');
            setTimeout(() => app.fit(), 300);
        };

        window.ui = {
            tab: (name) => {
                document.querySelectorAll('.panel-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
                document.getElementById('tab-' + name).classList.add('active');
                
                const btns = document.querySelectorAll('.tab-btn');
                const map = ['files', 'tools', 'light', 'color', 'fx'];
                btns.forEach(b => b.classList.remove('active'));
                if(map.indexOf(name) >= 0) btns[map.indexOf(name)].classList.add('active');
            },
            status: (msg, color='orange') => {
                const el = document.getElementById('statusText');
                el.innerText = msg; el.style.color = color;
            }
        };

        window.app = {
            canvas: document.getElementById('mainCanvas'),
            container: document.getElementById('canvasContainer'),
            ctx: document.getElementById('mainCanvas').getContext('2d'),
            
            bufs: { sticker: document.createElement('canvas'), compose: document.createElement('canvas'), brush: document.createElement('canvas') },
            ctxs: {}, bg: null, rawFG: null, noise: null,
            
            state: { 
                x: 0, y: 0, scale: 1, angle: 0, 
                dragging: false, mode: 'transform', 
                lastP: {x:0, y:0}, mouse: {x:-100, y:-100},
                displayScale: 1, 
                f: { 
                    opacity: 100, exposure: 0, brightness: 0, contrast: 0, highlights: 0, shadows: 0,
                    saturation: 0, vibrance: 0, temp: 0, tint: 0, hue: 0, sepia: 0,
                    fuzzRadius: 0, fuzzInt: 0, smooth: 0, sharpness: 0, noise: 0
                } 
            },

            init: function() {
                this.ctxs.sticker = this.bufs.sticker.getContext('2d');
                this.ctxs.compose = this.bufs.compose.getContext('2d');
                this.ctxs.brush = this.bufs.brush.getContext('2d');
                
                window.addEventListener('resize', () => this.fit());
                this.canvas.addEventListener('wheel', (e) => this.handleWheel(e), {passive: false});
                
                document.getElementById('fgInput').onchange = (e) => this.loadFG(e);
                document.getElementById('bgInput').onchange = (e) => this.loadBG(e);
                document.getElementById('btnSave').onclick = () => this.download();
                
                this.canvas.addEventListener('mousedown', (e) => this.start(e));
                window.addEventListener('mousemove', (e) => this.trackMouse(e));
                window.addEventListener('mouseup', () => this.end());
                this.canvas.addEventListener('touchstart', (e) => this.start(e), {passive:false});
                this.canvas.addEventListener('touchmove', (e) => {this.trackMouse(e); this.move(e)}, {passive:false});
                this.canvas.addEventListener('touchend', () => this.end());

                const sliders = [
                    'Exposure','Brightness','Contrast','Highlights','Shadows','Opacity',
                    'Saturation','Vibrance','Temp','Tint','Hue','Sepia',
                    'FuzzRadius','FuzzInt','Smooth','Sharpness','Noise'
                ];
                sliders.forEach(k => {
                    const el = document.getElementById('filter' + k);
                    if(el) el.oninput = (e) => { 
                        const stateKey = k.charAt(0).toLowerCase() + k.slice(1);
                        this.state.f[stateKey] = parseFloat(e.target.value);
                        this.draw();
                    };
                });

                document.getElementById('brushSize').oninput = (e) => { document.getElementById('valSize').innerText = e.target.value; this.draw(); };
                document.getElementById('brushFeather').oninput = (e) => { document.getElementById('valFeather').innerText = e.target.value; this.draw(); };
                document.getElementById('rotateSlider').oninput = (e) => { this.state.angle = parseInt(e.target.value); document.getElementById('valRot').innerText = this.state.angle + '°'; this.draw(); };
                document.getElementById('checkGhost').onchange = () => this.draw();
                
                this.setMode('transform');
                document.getElementById('fgInput').disabled = false;
                ui.status("✅ Cloud AI Ready", "#28a745");
            },

            handleWheel: function(e) {
                e.preventDefault();
                const delta = e.deltaY < 0 ? 1.1 : 0.9;
                const newScale = this.state.scale * delta;
                if(newScale > 0.1 && newScale < 10) { this.state.scale = newScale; this.draw(); }
            },

            loadFG: async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const raw = new Image();
                raw.src = URL.createObjectURL(file);
                raw.onload = () => { this.rawFG = raw; };
                ui.status("⏳ AI Processing...", "orange");

                try {
                    const config = {
                        publicPath: "https://staticimgly.com/@imgly/background-removal-data/1.5.5/dist/",
                        model: 'small', 
                        debug: true,
                        progress: (key, current, total) => { if(total > 0) ui.status(`AI: ${Math.round((current/total)*100)}%`, "orange"); }
                    };

                    const blob = await removeBackground(file, config);
                    const img = new Image();
                    img.onload = () => {
                        ui.status("✅ Done", "#28a745");
                        [this.bufs.sticker, this.bufs.compose, this.bufs.brush].forEach(c => { c.width = img.width; c.height = img.height; });
                        this.ctxs.sticker.drawImage(img, 0, 0);
                        this.fit();
                        
                        if(this.bg) {
                            this.state.x = this.bg.naturalWidth/2; this.state.y = this.bg.naturalHeight/2;
                            this.state.scale = (this.bg.naturalHeight*0.6)/img.height;
                        } else {
                            this.state.x = this.canvas.width/2; this.state.y = this.canvas.height/2;
                            const fitRatio = Math.min(this.canvas.width / img.width, this.canvas.height / img.height);
                            this.state.scale = fitRatio * 0.8;
                        }
                        this.draw();
                    };
                    img.src = URL.createObjectURL(blob);

                } catch (err) {
                    console.error(err);
                    ui.status("❌ Error: " + err.message, "red");
                }
            },

            loadBG: function(e){if(!e.target.files[0])return;const img=new Image();img.onload=()=>{this.bg=img;this.fit();if(this.bufs.sticker.width>0){this.state.x=this.bg.naturalWidth/2;this.state.y=this.bg.naturalHeight/2;this.state.scale=(this.bg.naturalHeight*0.6)/this.bufs.sticker.height;this.draw()}};img.src=URL.createObjectURL(e.target.files[0])},
            fit: function(){const p=this.canvas.parentElement;let cw=p.clientWidth,ch=p.clientHeight;let rw=cw,rh=ch;if(this.bg){rw=this.bg.naturalWidth;rh=this.bg.naturalHeight}else if(this.bufs.sticker.width>0){rw=this.bufs.sticker.width;rh=this.bufs.sticker.height}this.canvas.width=rw;this.canvas.height=rh;const ir=rw/rh,cr=cw/ch;let cssW,cssH;if(ir>cr){cssW=cw;cssH=cw/ir}else{cssH=ch;cssW=ch*ir}this.canvas.style.width=cssW+'px';this.canvas.style.height=cssH+'px';this.state.displayScale=rw/cssW;this.draw()},
            
            draw: function(){
                const ctx = this.ctx;
                const w = this.canvas.width, h = this.canvas.height;
                ctx.clearRect(0, 0, w, h);

                if(this.bg) ctx.drawImage(this.bg, 0, 0);

                if(document.getElementById('checkGhost').checked && this.rawFG){
                    ctx.save(); this.transform(ctx); ctx.globalAlpha = 0.4;
                    ctx.drawImage(this.rawFG, -this.rawFG.width/2, -this.rawFG.height/2);
                    ctx.restore();
                }

                if(this.bufs.sticker.width > 0){
                    const f = this.state.f;
                    const sw = this.bufs.sticker.width, sh = this.bufs.sticker.height;
                    const cx = this.ctxs.compose;

                    cx.clearRect(0, 0, sw, sh);

                    // --- A. Color Prep ---
                    let bVal = f.brightness + f.exposure + 100;
                    let css = `brightness(${bVal}%) contrast(${f.contrast+100}%) saturate(${f.saturation + f.vibrance + 100}%) hue-rotate(${f.hue}deg) sepia(${f.sepia}%)`;
                    
                    if(f.smooth > 0) css += ` blur(${f.smooth}px)`;

                    if(f.sharpness > 0){
                        const k = f.sharpness / 20;
                        document.getElementById('sharpMatrix').setAttribute('kernelMatrix', `0 ${-k} 0 ${-k} ${1+4*k} ${-k} 0 ${-k} 0`);
                        css += ` url(#svgSharpness)`;
                    }
                    
                    cx.filter = css;
                    
                    // --- B. Edge Fuzz (Feathering) ---
                    if(f.fuzzRadius > 0) {
                        cx.drawImage(this.bufs.sticker, 0, 0);
                        
                        // Use Brush Buffer to create a clean, CHOKED mask
                        // Previous logic was zooming IN (Crop->Full), which spread the mask out (and got clipped).
                        // We want to zoom OUT (Full->Shrunk) to pull the mask IN.
                        const bx = this.ctxs.brush;
                        bx.clearRect(0, 0, sw, sh);
                        bx.globalCompositeOperation = 'source-over';
                        
                        const ch = f.fuzzInt;
                        // Draw: Source(Full) -> Dest(Shrunk/Choked)
                        bx.drawImage(this.bufs.sticker, 0, 0, sw, sh, ch, ch, sw - ch*2, sh - ch*2);
                        
                        // Apply this mask to the Compose buffer
                        cx.globalCompositeOperation = 'destination-in';
                        cx.filter = `blur(${f.fuzzRadius}px)`;
                        cx.drawImage(this.bufs.brush, 0, 0); 
                        cx.filter = 'none'; 
                        
                        // Save result for cleanup step
                        bx.clearRect(0, 0, sw, sh);
                        bx.drawImage(this.bufs.compose, 0, 0);
                    } else {
                        cx.drawImage(this.bufs.sticker, 0, 0);
                    }

                    // --- C. Tints & Overlays ---
                    cx.globalCompositeOperation = 'source-atop';
                    cx.filter = 'none';

                    if(f.noise > 0){
                        if(!this.noise) this.genNoise(150);
                        cx.globalAlpha = f.noise / 100;
                        cx.fillStyle = this.noise;
                        cx.fillRect(0, 0, sw, sh);
                        cx.globalAlpha = 1;
                    }

                    if(f.highlights > 0){
                        cx.globalCompositeOperation = 'screen';
                        cx.fillStyle = `rgba(255,255,255,${f.highlights/100})`;
                        cx.fillRect(0, 0, sw, sh);
                    }

                    if(f.shadows > 0){
                        cx.globalCompositeOperation = 'multiply';
                        cx.fillStyle = `rgba(0,0,0,${f.shadows/100})`;
                        cx.fillRect(0, 0, sw, sh);
                    }

                    if(f.temp != 0) {
                        cx.globalCompositeOperation = 'overlay'; 
                        cx.fillStyle = f.temp > 0 ? `rgba(255,160,0,${Math.abs(f.temp)/100})` : `rgba(0,140,255,${Math.abs(f.temp)/100})`;
                        cx.fillRect(0, 0, sw, sh);
                    }

                    if(f.tint != 0) {
                        cx.globalCompositeOperation = 'overlay';
                        cx.fillStyle = f.tint > 0 ? `rgba(255,0,255,${Math.abs(f.tint)/100})` : `rgba(0,255,0,${Math.abs(f.tint)/100})`;
                        cx.fillRect(0, 0, sw, sh);
                    }

                    // --- D. Final Cleanup ---
                    // Restore the clean alpha edge
                    cx.globalCompositeOperation = 'destination-in';
                    if (f.fuzzRadius > 0) {
                         cx.drawImage(this.bufs.brush, 0, 0);
                    } else {
                         cx.drawImage(this.bufs.sticker, 0, 0);
                    }

                    cx.globalCompositeOperation = 'source-over';

                    // --- E. Output ---
                    ctx.save();
                    this.transform(ctx);
                    ctx.globalAlpha = f.opacity / 100;
                    ctx.drawImage(this.bufs.compose, -sw/2, -sh/2);
                    ctx.restore();
                }

                if(this.state.mode !== 'transform' && this.state.mouse.x > 0) {
                    ctx.save(); ctx.beginPath();
                    const sz = parseInt(document.getElementById('brushSize').value) * this.state.displayScale;
                    ctx.strokeStyle = 'white'; ctx.lineWidth = 2 * this.state.displayScale;
                    ctx.shadowColor = 'black'; ctx.shadowBlur = 4;
                    ctx.arc(this.state.mouse.x, this.state.mouse.y, sz, 0, Math.PI * 2);
                    ctx.stroke(); ctx.restore();
                }
            },

            transform: function(c){c.translate(this.state.x,this.state.y);c.rotate(this.state.angle*Math.PI/180);c.scale(this.state.scale,this.state.scale)},
            genNoise: function(amt){const c=document.createElement('canvas');c.width=100;c.height=100;const x=c.getContext('2d');const d=x.createImageData(100,100);const b=new Uint32Array(d.data.buffer);for(let i=0;i<b.length;i++)if(Math.random()<0.5)b[i]=(amt*2.55)<<24;x.putImageData(d,0,0);this.noise=this.ctx.createPattern(c,'repeat')},
            
            trackMouse: function(e){
                const r = this.canvas.getBoundingClientRect();
                let cx = e.clientX, cy = e.clientY;
                if(e.touches && e.touches.length > 0){ cx = e.touches[0].clientX; cy = e.touches[0].clientY; }
                this.state.mouse.x = (cx - r.left) * this.state.displayScale;
                this.state.mouse.y = (cy - r.top) * this.state.displayScale;
                if(this.state.dragging) this.move(e); else this.draw(); 
            },
            
            getPos: function(e){ return {x: this.state.mouse.x, y: this.state.mouse.y}; },
            start: function(e){ this.state.dragging = true; this.state.lastP = this.getPos(e); this.brush(e); },
            move: function(e){ 
                if(!this.state.dragging) return; 
                e.preventDefault(); 
                const p = this.getPos(e);
                if(this.state.mode==='transform'){
                    this.state.x += p.x - this.state.lastP.x;
                    this.state.y += p.y - this.state.lastP.y;
                    this.state.lastP = p;
                    this.draw();
                } else {
                    const dx = p.x - this.state.lastP.x, dy = p.y - this.state.lastP.y;
                    const d = Math.sqrt(dx*dx+dy*dy);
                    const sz = parseInt(document.getElementById('brushSize').value);
                    const step = Math.max(1, sz * 0.2);
                    const a = Math.atan2(dy, dx);
                    for(let i=0; i<d; i+=step) this.stamp(this.state.lastP.x + Math.cos(a)*i, this.state.lastP.y + Math.sin(a)*i);
                    this.state.lastP = p;
                    this.draw();
                }
            },
            end: function(){ this.state.dragging = false; },
            brush: function(e){ if(this.state.mode !== 'transform'){ const p = this.getPos(e); this.stamp(p.x, p.y); this.draw(); } },
            stamp: function(x, y){
                if(this.bufs.sticker.width === 0) return;
                let dx = x - this.state.x, dy = y - this.state.y;
                let r = -this.state.angle * Math.PI / 180;
                let rx = dx * Math.cos(r) - dy * Math.sin(r);
                let ry = dx * Math.sin(r) + dy * Math.cos(r);
                let lx = (rx / this.state.scale) + this.bufs.sticker.width/2;
                let ly = (ry / this.state.scale) + this.bufs.sticker.height/2;

                const sz = parseInt(document.getElementById('brushSize').value);
                const f = parseInt(document.getElementById('brushFeather').value);
                const sCtx = this.ctxs.sticker;

                if(this.state.mode === 'erase'){
                    sCtx.globalCompositeOperation = 'destination-out';
                    const g = sCtx.createRadialGradient(lx, ly, Math.max(0, sz - f), lx, ly, sz);
                    g.addColorStop(0, 'black'); g.addColorStop(1, 'transparent');
                    sCtx.fillStyle = g; sCtx.beginPath(); sCtx.arc(lx, ly, sz, 0, Math.PI*2); sCtx.fill();
                } else if(this.state.mode === 'restore' && this.rawFG){
                    const bCtx = this.ctxs.brush;
                    const diameter = sz * 2;
                    bCtx.canvas.width = diameter; bCtx.canvas.height = diameter;
                    const sx = lx - sz; const sy = ly - sz;
                    bCtx.clearRect(0, 0, diameter, diameter);
                    bCtx.drawImage(this.rawFG, sx, sy, diameter, diameter, 0, 0, diameter, diameter);
                    bCtx.globalCompositeOperation = 'destination-in';
                    const g = bCtx.createRadialGradient(sz, sz, Math.max(0, sz-f), sz, sz, sz);
                    g.addColorStop(0, 'black'); g.addColorStop(1, 'transparent');
                    bCtx.fillStyle = g; bCtx.beginPath(); bCtx.arc(sz, sz, sz, 0, Math.PI*2); bCtx.fill();
                    sCtx.globalCompositeOperation = 'source-over';
                    sCtx.drawImage(bCtx.canvas, lx-sz, ly-sz);
                }
            },
            setMode: function(m){
                this.state.mode = m;
                document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
                document.getElementById(m==='transform'?'btnTransform':(m==='erase'?'btnErase':'btnRestore')).classList.add('active');
                document.getElementById('brushControls').style.display=m==='transform'?'none':'block';
                if (m === 'transform') this.container.style.cursor = 'move';
                else this.container.style.cursor = 'none';
                this.draw();
            },
            resetFilters: function(){
                this.state.f={opacity:100,exposure:0,brightness:0,contrast:0,highlights:0,shadows:0,saturation:0,vibrance:0,temp:0,tint:0,hue:0,sepia:0,fuzzRadius:0,fuzzInt:0,smooth:0,sharpness:0,noise:0};
                document.querySelectorAll('.slider-grid input, #tab-fx input').forEach(i=>i.value=0);
                document.getElementById('filterOpacity').value = 100;
                this.draw();
            },
            download: function(){const lnk=document.createElement('a');lnk.download='imgpal-art.png';lnk.href=this.canvas.toDataURL();lnk.click()}
        };
        
        app.init();
    </script>
</body>
</html>
